---
title: "Automatic vs Manual Gear Analysis"
author: "Sandro Vicente"
output: html_document
---

#### Summary

In this report, we perform the analysis of data from 'mtcars' dataset in order to identify wheather automatic or manual transmission correspond to better MPG figures. Also we quantify the difference in MPG between transmission types (am).
In order to achive that, we perform a initial exploratory analysis over the data, then analyse models involving the mpg as result of am and other variables. We reach to a final model by adding variables whose inclusion present best p-values in the analysis of variance.

#### Analysis

```{r message=FALSE, warning=FALSE}
library(car)
data(mtcars)
```

We initially plot the variables with respect to mpg and transmission type in appendix plot 1.
Plot mpg X am shows a trend to higher mpg for manual transmission (red).

A basic linear model involving only mpg and transmission (am) confirms this.

```{r}
lm0 <- lm(mpg ~ factor(am)-1, data=mtcars)
summary(lm0)$coefficient
```

However a model involving only these variables may be innacurate and biased. We check other variables against transmission type in the model and select the ones whose inclusion present signficant p-values (< 0.05) in the analysis of variance . Both confounding and interactions are considered.

```{r}
vars <- c("cyl", "disp", "hp", "drat", "wt", "qsec", "gear", "carb" )
for (v in vars) {
    # confounding
    cf<-anova(lm(as.formula(paste("mpg ", v, sep="~")), data=mtcars),
             lm(as.formula(paste("mpg ~ factor(am) ", v, sep="+")), data=mtcars))
    # interaction only
    i<-anova(lm(as.formula(paste("mpg ", v, sep="~")), data=mtcars),
             lm(as.formula(paste("mpg ~ factor(am) ", v, sep=":")), data=mtcars))
    if (cf$Pr[2] < 0.05 && i$Pr[2] < 0.05) { print(data.frame(name=v,cf.pval=cf$Pr[2],i.pval=i$Pr[2])); }
}
```

The variables "hp", "qsec" and "carb" are significant (considering both methods) to be added in a model with transmission type. These represent the base models. 

New models are generated from the base models by adding the other shortlisted variables. The addition is then validated by observing the p-values for the analysis of variance and for the coefficients. p-value should be < 0.05.

```{r}
# base models
fit_hp <- lm(mpg ~ factor(am) + hp -1, data=mtcars)
fit_qsec <- lm(mpg ~ factor(am) + qsec -1, data=mtcars)
fit_carb <- lm(mpg ~ factor(am) + factor(carb) -1, data=mtcars)
# function to show coeficients within specified confidence levels
sig_coefficients <- function(x, err) { s <- summary(x)$coefficients;s[s[,4]<err,]}
# model 1 - am, hp, qsec
fit_hp_qsec <- update(fit_hp, mpg ~ factor(am) + hp * qsec -1)
# p-value for inclusion of variable in the model
anova(fit_hp, fit_hp_qsec)$Pr[2]
sig_coefficients(fit_hp_qsec, 0.05) ## not many good p-values, only 'qsec'
# model 2 - am, hp, carb
fit_hp_carb <- update(fit_hp, mpg ~ factor(am) + hp * carb -1)
# p-value for inclusion of variable in the model
anova(fit_hp, fit_hp_carb)$Pr[2] # best p-values
sig_coefficients(fit_hp_carb, 0.05) # best fit
# model 3 - am, hp, qsec, carb
fit_hp_qsec_carb <- update(fit_hp_carb, mpg ~ factor(am) + hp * qsec * carb -1)
# p-value for inclusion of variable in the model 
anova(fit_hp_carb, fit_hp_qsec_carb)$Pr[2] # not much influence
sig_coefficients(fit_hp_qsec_carb, 0.05) # no good p-values
```

Model 2 associating mpg to am, hp and carb is the one whose all coeficients have p-values under 0.05. 

Plot 2 in the appendix shows the diagnostic analysis for this model. No specific pattern is observed in the residuals charts. Normal Q-Q shows reasonable consistence between quantiles and residuals. Leverage chart shows strong influence of only one data point (Maserati Bora).

The coeficients are still consistent with the first test involving only transmission. Based on the data in mtcars, manual transmission is associated to higher mpg with 95% of confidence.  

From model 2, the coeficients for automatic (0) and manual (1) transimssions are respectively `r fit_hp_carb$coef[1]` and `r fit_hp_carb$coef[2]`, so for manual there is an increase of 4.73  +/- 2.06 in mpg. 


#### Appedix

```{r }
par(mfrow=c(3,3),mar=c(4,4,1,0), oma=c(0,0,2,0))

with(mtcars, plot(disp, mpg, pch=19, col=am+1))
with(mtcars, plot(hp, mpg, pch=19, col=am+1)) # good
with(mtcars, plot(drat, mpg, pch=19, col=am+1))
with(mtcars, plot(wt, mpg, pch=19, col=am+1))
with(mtcars, plot(qsec, mpg, pch=19, col=am+1)) # good
with(mtcars, plot(gear, mpg, pch=19, col=am+1))
with(mtcars, plot(carb, mpg, pch=19, col=am+1))
with(mtcars, plot(cyl, mpg, pch=19, col=am+1))
with(mtcars, plot(am, mpg, pch=19, col=am+1))

legend("top", pch = 19, col = c(0,1)+1, legend = c("Auto", "Man"))
mtext("Plot 1 - mpg and transmission X other variables",side=3, line=1, outer=TRUE)

par(mfrow=c(2,2), mar=c(5,4,1,0), oma=c(0,0,2,0))
plot(fit_hp_carb) 
mtext("Plot 2 - Analysis of diagnostic values for fit_hp_carb",side=3, line=1, outer=TRUE)

```