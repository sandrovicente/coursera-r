---
title: "Analysis of vitamin C intake against teeth growth"
author: "Sandro Vicente"
date: "Sunday, May 17, 2015"
output: html_document
---

### Overview

In this report we analyse the influence of Vitamin C against odontoblasts (teeth) growth in Guinea Pigs. 
We compare dosages and supplement types against the observed average teeth lengths, using both Normal distribution and Students distribution. Observations are initially split into groups regarding supplement type, then regarding dosage.
Finally both dosage and supplement types are analysed against average teeth lenght observed in its corresponding groups.

### Obtaining Data

Data is obtained from standard R datasets.

```{r} 
library(datasets)

library(ggplot2) # auxiliry libraries added
library(plyr)

## shows clusters
ggplot(data=ToothGrowth, aes(x=len, y=dose, group=supp, colour=supp)) +
    geom_point() + ggtitle("Fig. 1 - Distribution of length per supplement type and dose") 

```

A first exploratory plot (figure 1) shows that lenght tend to increase with the dose. 
OJ supplement seems to have more influence in growth for doses of 0.5mg and 1mg.

We can convert doses and supplement types into factors to perform further analysis.

```{r}
tg <- ToothGrowth
tg$dose <- factor(tg$dose)
tg$supp <- factor(tg$supp)

summary(tg)

table(tg[,c("supp", "dose")])
```
We have the same number of observations for each combination of doses (`r levels(tg$dose)`) and and supplements (`r levels(tg$supp)`).

We can initially explore how the type of supplement alone affects variations in length.

For that, a function is defined to take a number of samples and estimate the mean, standard error and the limits of values for a confidence interval using the Central Limit Theorem.

*Here we assume all samples are IID*
```{r}
calc_interval <- function(x, conf) {
    quantile <- 1-(1-conf)/2
    n <- length(x)
    sdn <- sd(x)/sqrt(n)
    m <- mean(x)
    interval <- (m+c(-1,1)*qnorm(quantile)*sdn)    
    list(quantile=quantile, n=n, sd=sdn, m=m, interval=interval)
} 

confidence <- 0.95 
```

Analysis over different supplement types. 
For all analysis we use the confidence interval of `r confidence`.
```{r}
data.supp <- data.frame()
for (supp in levels(tg$supp)) {
    x=tg[tg$supp==supp,"len"]
    data.supp <- rbind(data.supp, data.frame(x=x, type=supp))
    l <- calc_interval(x, confidence)
    print(sprintf("Supplement: %s, mean: %f, sd: %f, size: %d, range:[%f, %f]", supp, l$m, l$sd, l$n, l$interval[1], l$interval[2]))
}
```

Both invervals overlap, therefore, following the normal distribution the supplement type alone cannot significantly determine the average teeth length of the population with a confidence of `r confidence*100`%.

Since the sample size is relatively small, we can use the T distribution to test the samples regarding supplement types. We assume that the observations are statistically independent.

```{r}
t.test(x ~ type, data=data.supp)$conf
```

Zero is in the confidence interval, which confirms that the supplement type cannot determine the teeth lenght.

We can proceed with the analysis of the impact of the dosage on the average length of the population.

```{r}

data.type <- data.frame()  # dataframe containg data per type (i.e. per dose)
norm.type <- data.frame()  # dataframe containg summarized for normal distribution per type (i.e. per dose)
for (dose in levels(tg$dose)) {
    x <- tg[tg$dose==dose,"len"]
    ds <- data.frame(x=x, type=dose)  
    data.type <- rbind(data.type, ds)
    
    l <- calc_interval(x, confidence)
    norm.type <- rbind(norm.type, data.frame(m=l$m, sd=l$sd, type=dose)) # data for normal distribution of sample
    
    print(sprintf("Dosage: %s mg, mean: %f, sd: %f, size: %d, range:[%f, %f]", dose, l$m, l$sd, l$n, l$interval[1], l$interval[2]))
}

# Calculate normal values for reference 
len.min <- min(tg$len) # minimum length
len.max <- max(tg$len) # maximum legth
len.x <- seq(len.min, len.max, length=100) # range of lengths from min to max 

# function to calculate normal densities given data frame containg "type", "m" mean and "sd" sample's standard deviation
calc_normal <- function(nt) {
    ddply(norm.type, "type", function(df) {
        data.frame( 
            predicted = len.x,
            density = dnorm(len.x, mean=df$m, sd=df$sd)
        )
    })
}

normaldens <- calc_normal(norm.type) # normal densities for the corresponding types

# plot histogram and corresponding normal distributions in separated frames
ggplot(data.type, aes(x=x, fill=type)) +  geom_histogram(alpha = 0.5, aes(y = ..density..), position = 'identity') +
    geom_line(data=normaldens, aes(x = predicted, y=density)) +
    facet_wrap(~ type, ncol=3) +
    xlab("Length") + ggtitle("Fig. 2.a - Teeth length and its average distribution per dosage") 

# plot histogram and normal distributions altogether
ggplot(data.type, aes(x=x, fill=type)) +  geom_histogram(alpha = 0.5, aes(y = ..density..), position = 'identity') +
    geom_line(data=normaldens, aes(x=predicted, y=density, color=type)) +
    xlab("Length") + ggtitle("Fig. 2.b - Teeth length and its average distribution per dosage overlayed") 

```

The observations show strong evidence of increase on the average teeth size in populations with consumption of higher dosage of Vitamin C, . 
The distributions of the average length in populations for different dosages are show in figures 2.a and 2.b.
In other words, the average teeth length of a population can determine the dosage of Vitamin C consumed with `r confidence*100`% of confidence.

Again, due to relatively small sample sizes, we can verify this using T-student. As stated earlier, we assume that observations are statistically independent.

```{r}

apply(combn(levels(data.type$type),2, simplify=T), 2, function(t) {c(t, t.test(x ~ type, data=subset(data.type, type %in% t))$conf)})
    
```

Zero isn't included in any of the ranges, which confirms statistically significant association between dosage and average teeth size.

It remains to be seen wheather the supplement type, for a given dosage, has impact on the average size of the teeth in a population.  
For that, we drill down into supplement types and doses

```{r}

data.type <- data.frame()  # reset dataframe containg data per type (i.e. per dose and supp)
norm.type <- data.frame()  # reset dataframe containg summarized for normal distribution per type (i.e. per dose and supp)
for (dose in levels(tg$dose)) {
    for (supp in levels(tg$supp)) {
        x <- tg[tg$supp==supp & tg$dose==dose,"len"] # filter supp and dose
        l <- calc_interval(x, confidence)
        
        ds <- data.frame(x=x, type=paste(supp,dose,sep="-")) # type defined as composition supp "-" dose
        data.type <- rbind(data.type, ds)
        norm.type <- rbind(norm.type, data.frame(m=l$m, sd=l$sd, type=paste(supp,dose,sep="-"))) # type defined as composition supp "-" dose

        print(sprintf("Supplement:%s, Dosage: %s mg, mean: %f, sd: %f, size: %d, range:[%f, %f]", supp, dose, l$m, l$sd, l$n, l$interval[1], l$interval[2]))
    }
}

# calculate normal distribution for types based on dose and supp
normaldens <- calc_normal(norm.type)

# plot histogram and corresponding normal distributions in separated frames
ggplot(data.type, aes(x=x, fill=type)) +  geom_histogram(alpha = 0.5, aes(y = ..density..), position = 'identity') +
    geom_line(data=normaldens, aes(x = predicted, y=density)) +
    facet_wrap(~ type, ncol=3) + 
    xlab("Length") + ggtitle("Fig. 3.a - Length and average distribution / dosage and supplement") 

# plot histogram and corresponding normal distributions althogether
ggplot(data.type, aes(x=x, fill=type)) +  geom_histogram(alpha = 0.5, aes(y = ..density..), position = 'identity') +
    geom_line(data=normaldens, aes(x=predicted, y=density, color=type))+ 
    xlab("Length") + ggtitle("Fig. 3.b - Length and avg. distribution / dosage and supplement (overlay)") 

```

From the values obtained and from the figures 3a and 3b, we can see that the supplement type has more influence in the average lenght for lower dosages, especially for 0.5 mg.
For this dosage, the OJ correspond to a greater average teeth leght, compared to VC. 

In particular, the average length distribution for the group OJ-0.5 overlaps the length distribution for the group VC-1, so the average length cannot distinguish such groups with the given confidence.
The same happens with the distributions of average lengths for the groups OJ-1,  OJ-2 and VC-2.

For the dosage of 2mg (OJ-2 and VC-2), the distributions are superposed, with almost the same mean. For the level of confidence of `r confidence*100`%, the average teeth lenght of a population cannot distinguish if it is in the groups OJ-1, OJ-2 or VC-2.

The samples for these groups are the smallest, so it is important to confirm the results with T tests. We assume independent observations.

``` {r}

apply(combn(levels(data.type$type),2, simplify=T), 2, function(t) {
    conf <- t.test(x ~ type, data=subset(data.type, type %in% t))$conf
    c(t, conf, ifelse(conf[1]*conf[2]>0,"OK","UNCONFIRMED"))
})
    
```

Interestingly, for tests with Student's T distribution, the intervals show that the lenghts can be significantly (`r confidence*100`%) mapped into each of the groups with only the exceptions of groups OJ-1 agaist VC-2 and OJ-2 against VC-2. 

These results confirm that at lower dosages, the supplement has stronger influence on the average teeth length. Specifically, the OJ supplement is more effective in increasing the length.

OJ for 1mg is not distinguishable from VC for 2mg, and for the dosage of 2mg, both OJ and VC supplements have similar infuence.